(function(c,d){typeof exports=="object"&&typeof module<"u"?module.exports=d():typeof define=="function"&&define.amd?define(d):(c=typeof globalThis<"u"?globalThis:c||self,c.Playsaurus=d())})(this,function(){"use strict";var ae=Object.defineProperty;var oe=(c,d,_)=>d in c?ae(c,d,{enumerable:!0,configurable:!0,writable:!0,value:_}):c[d]=_;var s=(c,d,_)=>(oe(c,typeof d!="symbol"?d+"":d,_),_);let c;const d=new Uint8Array(16);function _(){if(!c&&(c=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!c))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return c(d)}const o=[];for(let n=0;n<256;++n)o.push((n+256).toString(16).slice(1));function B(n,e=0){return o[n[e+0]]+o[n[e+1]]+o[n[e+2]]+o[n[e+3]]+"-"+o[n[e+4]]+o[n[e+5]]+"-"+o[n[e+6]]+o[n[e+7]]+"-"+o[n[e+8]]+o[n[e+9]]+"-"+o[n[e+10]]+o[n[e+11]]+o[n[e+12]]+o[n[e+13]]+o[n[e+14]]+o[n[e+15]]}const M={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function F(n,e,t){if(M.randomUUID&&!e&&!n)return M.randomUUID();n=n||{};const i=n.random||(n.rng||_)();if(i[6]=i[6]&15|64,i[8]=i[8]&63|128,e){t=t||0;for(let r=0;r<16;++r)e[t+r]=i[r];return e}return B(i)}class I{constructor(e,t,i,r,a){s(this,"id");s(this,"session");s(this,"name");s(this,"timestamp");s(this,"properties");s(this,"sendCount",0);this.id=a??F(),this.session=e,this.name=t,this.timestamp=i,this.properties=r??{}}toJSON(){return{id:this.id,name:this.name,t:this.timestamp.toISOString(),properties:Object.keys(this.properties).length>0?this.properties:void 0}}toStorage(){return this.toJSON()}static fromStorage(e,t){const i=t.name,r=new Date(t.t),a=t.properties,l=t.id;return new I(e,i,r,a,l)}}class U{constructor(e){s(this,"session");s(this,"status","pending");s(this,"shouldRetry",!1);if(this.events=e,e.length===0)throw new Error("The events list cannot be empty.");this.events=e,this.session=e[0].session;for(const t of e)if(t.session!==this.session)throw new Error("All events must belong to the same session.")}markAsFailAndRetry(){this.status="failed",this.shouldRetry=!0}markAsFailAndSkip(){this.status="failed",this.shouldRetry=!1}markAsSent(){this.status="sent",this.shouldRetry=!1}}class f{constructor(){s(this,"id",null);s(this,"pendingEvents",[]);s(this,"nextHeartbeatAt",null);s(this,"userAtomicId",null);s(this,"userId",null);s(this,"userUid",null);s(this,"gameVersion",null);s(this,"analyticsSdkVersion",null);s(this,"osName",null);s(this,"osVersion",null);s(this,"deviceModel",null);s(this,"deviceType",null);s(this,"deviceManufacturer",null);s(this,"deviceLocale",null);s(this,"gameLocale",null);s(this,"deviceTimezone",null);s(this,"deviceRamMb",null);s(this,"deviceCpuCores",null);s(this,"deviceCpuMhz",null);s(this,"deviceVramMb",null);s(this,"gameGraphicsApi",null);s(this,"screenWidth",null);s(this,"screenHeight",null);s(this,"screenDpi",null);s(this,"screenCount",null);s(this,"connectionType",null);s(this,"gamePlatform",null);s(this,"gameStorefront",null);s(this,"deviceGaid",null);s(this,"deviceIdfa",null);s(this,"steamId",null)}get isSubmitted(){return this.id!==null}pushEvent(e,t){const i=new I(this,e,new Date,t);return this.pendingEvents.push(i),i}dequeueEvents(e){return this.pendingEvents.splice(0,e)}returnFailedEventsToQueue(e){this.pendingEvents.push(...e)}createBatches(e){const t=[];let i=this.dequeueEvents(e);for(;i.length>0;)t.push(new U(i)),i=this.dequeueEvents(e);return t}toJSON(){return f._removeNulls({user_atomic_id:this.userAtomicId,user_id:this.userId,user_uid:this.userUid,game_version:this.gameVersion,analytics_sdk_version:this.analyticsSdkVersion,os_name:this.osName,os_version:this.osVersion,device_model:this.deviceModel,device_type:this.deviceType,device_manufacturer:this.deviceManufacturer,device_locale:this.deviceLocale,game_locale:this.gameLocale,device_timezone:this.deviceTimezone,device_ram_mb:this.deviceRamMb,device_cpu_cores:this.deviceCpuCores,device_cpu_mhz:this.deviceCpuMhz,device_vram_mb:this.deviceVramMb,game_graphics_api:this.gameGraphicsApi,screen_width:this.screenWidth,screen_height:this.screenHeight,screen_dpi:this.screenDpi,screen_count:this.screenCount,connection_type:this.connectionType,game_platform:this.gamePlatform,game_storefront:this.gameStorefront,device_gaid:this.deviceGaid,device_idfa:this.deviceIdfa,steam_id:this.steamId})}static _removeNulls(e){return Object.keys(e).forEach(t=>{(e[t]===null||e[t]===void 0)&&delete e[t]}),e}toStorage(){return{id:this.id,...this.toJSON(),pending_events:this.pendingEvents.map(e=>e.toStorage())}}static fromStorage(e){const t=Object.assign(new f,f._removeNulls({id:e.id,userAtomicId:e.user_atomic_id,userId:e.user_id,userUid:e.user_uid,gameVersion:e.game_version,analyticsSdkVersion:e.analytics_sdk_version,osName:e.os_name,osVersion:e.os_version,deviceModel:e.device_model,deviceType:e.device_type,deviceManufacturer:e.device_manufacturer,deviceLocale:e.device_locale,deviceTimezone:e.device_timezone,gameLocale:e.game_locale,deviceRamMb:e.device_ram_mb,deviceCpuCores:e.device_cpu_cores,deviceCpuMhz:e.device_cpu_mhz,deviceVramMb:e.device_vram_mb,gameGraphicsApi:e.game_graphics_api,screenWidth:e.screen_width,screenHeight:e.screen_height,screenDpi:e.screen_dpi,screenCount:e.screen_count,userAgent:e.user_agent,connectionType:e.connection_type,gamePlatform:e.game_platform,gameStorefront:e.game_storefront,deviceGaid:e.device_gaid,deviceIdfa:e.device_idfa,steamId:e.steam_id}));return e.pending_events&&(t.pendingEvents=e.pending_events.map(i=>I.fromStorage(t,i))),t}}var h=(n=>(n.Offline="offline",n.Online="online",n.Wifi="wifi",n.Ethernet="ethernet",n.Mobile="mobile",n))(h||{}),b=(n=>(n.Windows="windows",n.Linux="linux",n.MacOS="macos",n.Android="android",n.IOS="ios",n))(b||{});class ${static getConnectionType(){const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;if(!e)return h.Online;const t={bluetooth:h.Mobile,cellular:h.Mobile,ethernet:h.Ethernet,none:h.Offline,wifi:h.Wifi,wimax:h.Mobile,unknown:null}[e.type];return t||(e.saveData===!0?h.Mobile:h.Online)}}const D=class D{constructor(){s(this,"_atomicId",null)}static get instance(){return this._instance??(this._instance=new D),this._instance}async getId(){return this._atomicId?this._atomicId:(this._atomicId=localStorage.getItem("playsaurus-atomic-id"),this._atomicId?this._atomicId:(this._atomicId=F(),localStorage.setItem("playsaurus-atomic-id",this._atomicId),this._atomicId))}};s(D,"_instance",null);let A=D;class k{constructor(){s(this,"_initialized",!1)}async collect(e,t){return this._initialized||(await this.initialize(),this._initialized=!0),this.fillContextInfo(e,t),e.userAtomicId=await this.getAtomicId(),e.connectionType=this.getConnectionType(),e.osName=this.getOsName(),e.osVersion=this.getOsVersion(),e.deviceModel=this.getDeviceModel(),e.deviceType=this.getDeviceType(),e.deviceManufacturer=this.getDeviceManufacturer(),e.deviceLocale=this.getDeviceLocale(),e.deviceTimezone=this.getDeviceTimezone(),e.deviceRamMb=this.getDeviceRamMb(),e.deviceCpuCores=this.getDeviceCpuCores(),e.deviceCpuMhz=this.getDeviceCpuMhz(),e.deviceVramMb=this.getDeviceVramMb(),e.gameGraphicsApi=this.getGameGraphicsApi(),e.screenWidth=this.getScreenWidth(),e.screenHeight=this.getScreenHeight(),e.screenDpi=this.getScreenDpi(),e.screenCount=this.getScreenCount(),Promise.resolve()}async initialize(){return Promise.resolve()}fillContextInfo(e,t){e.gameVersion=t.gameVersion,e.analyticsSdkVersion=t.analyticsSdkVersion,e.gameLocale=t.gameLocale,e.gamePlatform=t.gamePlatform,e.gameStorefront=t.gameStorefront,e.userUid=t.userUid,e.steamId=t.steamId,e.deviceIdfa=t.deviceIdfa,e.deviceGaid=t.deviceGaid}async getAtomicId(){return A.instance.getId()}getOsName(){return null}getOsVersion(){return null}getDeviceModel(){return null}getDeviceManufacturer(){return null}getDeviceType(){return null}getDeviceLocale(){return navigator.language}getDeviceTimezone(){return Intl.DateTimeFormat().resolvedOptions().timeZone}getDeviceCpuMhz(){return null}getGameGraphicsApi(){return null}getDeviceRamMb(){return typeof navigator.deviceMemory<"u"?navigator.deviceMemory*1024:null}getScreenWidth(){return window.devicePixelRatio?Math.floor(window.screen.width*window.devicePixelRatio):window.screen.width}getScreenHeight(){return window.devicePixelRatio?Math.floor(window.screen.height*window.devicePixelRatio):window.screen.height}getScreenDpi(){return window.devicePixelRatio?Math.round(window.devicePixelRatio*96):null}getConnectionType(){return $.getConnectionType()}getDeviceCpuCores(){return typeof navigator.hardwareConcurrency<"u"?navigator.hardwareConcurrency:null}getDeviceVramMb(){return null}getScreenCount(){return window.screen&&typeof window.screen.isExtended<"u"?window.screen.isExtended?2:1:null}}class q{constructor(e){s(this,"event");this.event=e}get session(){return this.event.session}get queueLength(){return this.session.pendingEvents.length}}class W{async get(e){return localStorage.getItem(e)}async set(e,t){localStorage.setItem(e,t)}async remove(e){localStorage.removeItem(e)}}class J{constructor(e){s(this,"_pendingSessions",new Set);s(this,"_storage");this._storage=e}add(e){this._pendingSessions.add(e)}addRange(e){for(const t of e)this.add(t)}remove(e){this._pendingSessions.delete(e)}async save(){const e={v:1,sessions:[...this._pendingSessions].map(t=>t.toStorage())};await this._storage.set("playsaurus-analytics-sessions",JSON.stringify(e))}async restore(){const e=await this._storage.get("playsaurus-analytics-sessions");if(!e)return[];const t=JSON.parse(e);if(t.v!==1)return[];const i=t.sessions.map(r=>f.fromStorage(r));for(const r of i)this.add(r);return i}getAll(){return[...this._pendingSessions]}dequeueAll(){const e=this.getAll();return this._pendingSessions.clear(),e}}class j{constructor(e,t){s(this,"_timeoutId",null);s(this,"_failedAttempts",0);s(this,"_nextFlushAt",null);s(this,"_nextHeartbeatAt",null);s(this,"dateProvider",()=>new Date);s(this,"onFlush");s(this,"debounceTime",15);s(this,"_currentBackoffTime",-1);this.onFlush=e,this.debounceTime=t||this.debounceTime}get failedAttempts(){return this._failedAttempts}get nextFlushAt(){return this._nextFlushAt}get nextHeartbeatAt(){return this._nextHeartbeatAt}get retryTime(){return this._currentBackoffTime}_scheduleNextFlushIn(e){this._timeoutId&&window.clearTimeout(this._timeoutId),e*=1e3,this._nextFlushAt=new Date(Date.now()+e),this._timeoutId=window.setTimeout(this.onFlush,e)}clear(){this._timeoutId&&(window.clearTimeout(this._timeoutId),this._timeoutId=null)}_getExponentialBackoff(e){return Math.min(Math.pow(2,e-1)*this.debounceTime,3600)}scheduleRetry(){this._currentBackoffTime=this._getExponentialBackoff(++this._failedAttempts),this._scheduleNextFlushIn(this._currentBackoffTime)}scheduleNextFlush(){this._failedAttempts=0,this._currentBackoffTime=-1,this._scheduleNextFlushIn(this.debounceTime)}scheduleHeartbeatAt(e){if(!e){this._nextHeartbeatAt=null;return}if(this._nextFlushAt&&e<this._nextFlushAt)return;const t=e.getTime()-this.dateProvider().getTime();this._nextHeartbeatAt=e,this._scheduleNextFlushIn(t/1e3)}get isHeartbeatTime(){if(this._nextHeartbeatAt===null)return!1;const e=10*1e3,t=this.dateProvider().getTime(),i=this._nextHeartbeatAt.getTime();return t>=i-e&&t<=i+e}}class E{constructor(){s(this,"_start");this._start=new Date().getTime()}static start(){return new E}get elapsed(){return new Date().getTime()-this._start}}class v extends Error{constructor(t,i,r){super(t??`Request failed with status code ${(i==null?void 0:i.status)??0}`);s(this,"response");s(this,"shouldRetry");s(this,"duration");this.response=i??null,this.shouldRetry=this._shouldRetry(i),this.duration=r??0}static fromResponse(t,i){return new v(void 0,t,i)}static deviceOffline(){return new v("Device is offline")}_shouldRetry(t){if(!t)return!1;const i=Math.floor(((t==null?void 0:t.status)??0)/100);return i===5||i===0||t.status===429}}class G{constructor(e){s(this,"baseUrl","");s(this,"supportsBeaconAPI",navigator.sendBeacon!==void 0);this.baseUrl=e}async send(e,t){const i=this._getEventPayload(t,e),r=E.start(),a=await fetch(`${this.baseUrl}/events`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(i),keepalive:!0}),l=r.elapsed;if(!a.ok)throw v.fromResponse(a,l);const y=await a.json();return{response:a,duration:l,data:y}}sendHeartbeat(e){return this.send(e,[])}sendWithBeaconAPI(e,t){if(!this.supportsBeaconAPI)return!1;const i=this._getEventPayload(t,e),r=new Blob([JSON.stringify(i)],{type:"application/json"});return navigator.sendBeacon(`${this.baseUrl}/events`,r)}_getEventPayload(e,t){const i=t.id===null;return{ts:new Date().toISOString(),events:e.map(r=>r.toJSON()),session:i?t.toJSON():void 0,session_id:i?void 0:t.id}}}class Q{constructor(e,t,i){s(this,"events");s(this,"response",null);s(this,"duration",-1);s(this,"innerError",null);this.events=e,this.response=t instanceof v?t.response:null,this.innerError=t??null,this.duration=i??-1}get session(){return this.events[0].session}}class P{constructor(e){s(this,"events");this.events=e}get session(){return this.events[0].session}}class X{constructor(e,t,i){s(this,"events");s(this,"response",null);s(this,"duration",0);this.events=e,this.response=t??null,this.duration=i??-1}get session(){return this.events[0].session}}class K{constructor(e,t){s(this,"onEventsSending",()=>{});s(this,"onEventsSent",()=>{});s(this,"onEventsFailed",()=>{});s(this,"_broker");s(this,"maxEventsPerRequest",20);this._broker=new G(e),this.maxEventsPerRequest=t??20}_createBatches(e){return e.flatMap(t=>t.createBatches(this.maxEventsPerRequest))}async flush(e){if(e.length===0)return[];const t=this._createBatches(e);let i=!1;for(let r=0;r<t.length;r++){const a=t[r];if(i){a.markAsFailAndRetry();continue}if(await this._sendbatch(a),a.shouldRetry){i=!0;break}}if(i)for(const r of t.filter(a=>a.shouldRetry))r.session.returnFailedEventsToQueue(r.events);return t}async sendHeartbeat(e){const{data:t}=await this._broker.sendHeartbeat(e);e.id=t.session_id,e.nextHeartbeatAt=new Date(t.next_heartbeat_at)}flushWithBeacon(e){if(e.length===0)return[];const t=this._createBatches(e);for(const i of t)this._sendItemWithBeaconAPI(i);return t}_sendItemWithBeaconAPI(e){const{session:t,events:i}=e;if(t.userAtomicId===null){e.markAsFailAndRetry();return}if(navigator.onLine===!1){e.markAsFailAndRetry();return}this.onEventsSending(new P(i)),this._broker.sendWithBeaconAPI(t,i)?e.markAsSent():e.markAsFailAndRetry()}async _sendbatch(e){const{session:t,events:i}=e;if(t.userAtomicId===null){e.markAsFailAndRetry();return}if(navigator.onLine===!1){e.markAsFailAndRetry();return}this.onEventsSending(new P(i));try{const{response:r,duration:a,data:l}=await this._broker.send(t,i);t.id=l.session_id,t.nextHeartbeatAt=new Date(l.next_heartbeat_at),this.onEventsSent(new X(i,r,a)),e.markAsSent()}catch(r){const a=r instanceof v?r.shouldRetry:!0,l=r instanceof v?r.duration:0;a?e.markAsFailAndRetry():e.markAsFailAndSkip(),this.onEventsFailed(new Q(i,r,l))}}}class Z{constructor(e,t){s(this,"batches");s(this,"retryAfter");this.batches=e,this.retryAfter=t}}var T=(n=>(n.Other="other",n.Web="web",n.Desktop="desktop",n.Ios="ios",n.Android="android",n))(T||{});class Y{constructor(e){s(this,"sdkVersion",u.version);s(this,"gameVersion",null);s(this,"endpoint","");s(this,"platform",T.Web);s(this,"maxEventsPerRequest",20);s(this,"flushDebounceTime",15);s(this,"steamId");s(this,"_onEventQueued");s(this,"_onRetryScheduled");s(this,"_session",null);s(this,"_pendingSessions");s(this,"_isSending",!1);s(this,"_scheduler");s(this,"_dataCollector");s(this,"_storage");s(this,"_collectionContext");s(this,"_flushingService");if(!e.gameSlug)throw new Error("The game slug is required.");if(!e.endpoint)throw new Error("The endpoint is required.");this.endpoint=`${e.endpoint}/games/${e.gameSlug}`;const t=e.analytics??{};this.maxEventsPerRequest=t.maxEventsPerRequest??20,this.flushDebounceTime=t.flushDebounceTime??15,this._collectionContext={gameVersion:e.gameVersion??null,analyticsSdkVersion:this.sdkVersion,gamePlatform:e.gamePlatform??T.Web,gameStorefront:e.gameStorefront??null,gameLocale:u.locale,userUid:u.config.userUid??null,deviceGaid:t.deviceGaid??null,deviceIdfa:t.deviceIdfa??null,steamId:typeof t.steamId=="bigint"?t.steamId.toString():t.steamId??null},this._onEventQueued=t.onEventQueued??(()=>{}),this._onRetryScheduled=t.onRetryScheduled??(()=>{}),this._dataCollector=t.dataCollector??new k,this._storage=t.storageDriver??new W,this._pendingSessions=new J(this._storage),this._flushingService=new K(this.endpoint,this.maxEventsPerRequest),this._flushingService.onEventsSending=t.onAnalyticsSending??(()=>{}),this._flushingService.onEventsSent=t.onAnalyticsSent??(()=>{}),this._flushingService.onEventsFailed=t.onAnalyticsFailed??(()=>{}),this._scheduler=new j(()=>this.flush(),this.flushDebounceTime),this._session=this._newSession(),this._pendingSessions.restore(),window.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&this._flushWithBeaconAPI()}),this._scheduler.scheduleNextFlush()}notifyLocaleChanged(){this._collectionContext.gameLocale=u.locale,this.sendEvent("locale_changed",{locale:u.locale})}_newSession(){const e=new f;return this._session=e,this.sendEvent("session_started"),this._collectData(e),e}async endSession(){if(this._scheduler.clear(),!this._session)return Promise.resolve();this.sendEvent("session_ended"),await this.flush(),this._session=null}_getActiveSession(){return this._session??(this._session=this._newSession()),this._session}sendEvent(e,t){const i=this._getActiveSession(),r=i.pushEvent(e,t);this._pendingSessions.add(i),this._onEventQueued(new q(r)),i.pendingEvents.length>=this.maxEventsPerRequest?this._scheduler.failedAttempts===0&&this.flush():this._scheduler.scheduleNextFlush()}async _collectData(e){e.userAtomicId===null&&(await this._dataCollector.collect(e,this._collectionContext),await this._pendingSessions.save())}async flush(){if(!this._isSending){this._isSending=!0;try{await this._pendingSessions.save();const e=this._pendingSessions.dequeueAll(),t=this._scheduler.isHeartbeatTime;if(e.length===0&&t&&this._session!==null){await this._flushingService.sendHeartbeat(this._session),this._isSending=!1;return}const r=(await this._flushingService.flush(e)).filter(a=>a.shouldRetry);r.length>0?(this._pendingSessions.addRange(r.map(a=>a.session)),this._scheduler.scheduleRetry(),this._onRetryScheduled(new Z(r,this._scheduler.retryTime))):this._scheduler.scheduleNextFlush(),await this._pendingSessions.save()}finally{this._session&&this._session.nextHeartbeatAt&&this._scheduler.scheduleHeartbeatAt(this._session.nextHeartbeatAt),this._isSending=!1}}}_flushWithBeaconAPI(){if(navigator.sendBeacon===void 0){this.flush();return}const e=this._pendingSessions.getAll(),t=e.filter(r=>r.id===null),i=e.filter(r=>r.id!==null);this._flushingService.flushWithBeacon(t),this._flushingService.flush(i)}}class R{constructor(){s(this,"id","");s(this,"locale","en");s(this,"title","");s(this,"body","");s(this,"button","");s(this,"link","");s(this,"image",{url:"",alt:""});s(this,"_sw",null);s(this,"_clicked",!1);s(this,"_finalReadTime",null)}static fromRequest(e){const t=new R;return t.id=e.id,t.locale=e.locale,t.title=e.title,t.body=e.body,t.button=e.button,t.link=e.link,t.image=e.image,t}start(){if(this._sw!==null)throw new Error("Announcement has already been started.");this._sw=E.start()}markAsClicked(){this.markAsDismissed(!0)}markAsDismissed(e=!1){if(this._sw===null)throw new Error("Announcement has not been started.");this._clicked=e,this._finalReadTime=this._sw.elapsed,this._sw=null}get isRunning(){return this._sw!==null}get clicked(){return this._clicked}get readTime(){return this._finalReadTime!==null?this._finalReadTime:this._sw===null?0:this._sw.elapsed}}class ee{constructor(e,t){s(this,"_parent");s(this,"_announcement",null);s(this,"_dialog",null);s(this,"onClicked",()=>{});s(this,"onDismissed",()=>{});s(this,"_options");s(this,"_closeIconSvg",`
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
        </svg>
    `);this._announcement=e,this._parent=document.body,this._options=t||{},this.render()}get announcement(){return this._announcement}set announcement(e){this._announcement!==e&&(this._announcement=e,this.render())}render(){var H,V;if(this._dialog===null&&(this._dialog=document.createElement("dialog"),this._dialog.classList.add("playsaurus-announcement-dialog"),this._dialog.classList.add(this._options.theme||"light"),this._parent.appendChild(this._dialog)),this._announcement===null){this._dialog.innerHTML="";return}const e=this._announcement.title,t=this._announcement.body,i=this._announcement.button||"Learn More",r=(H=this._announcement.image)==null?void 0:H.url,a=((V=this._announcement.image)==null?void 0:V.alt)||e,l=this._announcement.link,y=[];if(r&&y.push(`<img class="image" src="${r}" alt="${a}"/>`),t&&y.push(`<p class="body">${t}</p>`),l){const p=l.startsWith("http")?l:"javascript:void(0)";y.push(`<a href="${p}" target="_blank" class="button">
                ${i}
            </a>`)}const ne=`<button class="close-button">${this._closeIconSvg}</button>`,re=`<div class="header">
            <h1 class="title">${e}</h1>
            ${ne}
        </div>`;this._dialog.innerHTML=`
            ${re}
            ${y.join(`
`)}
        `;const N=this._dialog.querySelector("a.button"),O=this._dialog.querySelector("button.close-button");N&&N.addEventListener("click",p=>{var z;l&&!l.startsWith("http")&&p.preventDefault(),(z=this._dialog)==null||z.close(),this.onClicked()}),O&&O.addEventListener("click",p=>{var S;p.preventDefault(),(S=this._dialog)==null||S.close(),this.onDismissed()}),this._options.dismissable&&this._dialog.addEventListener("click",p=>{var S;p.target===this._dialog&&((S=this._dialog)==null||S.close(),this.onDismissed())})}show(){var e;(e=this._dialog)==null||e.showModal()}}class te{constructor(e){s(this,"_endpoint");s(this,"_defaultHeaders",{});s(this,"platform");s(this,"_atomicId",null);if(!e.gameSlug)throw new Error("The game slug is required");if(!e.endpoint)throw new Error("The endpoint is required");this._endpoint=`${e.endpoint}/games/${e.gameSlug}/announcements`,this.platform=e.gamePlatform||T.Web,this._updateHeaders()}notifyLocaleChanged(){this._updateHeaders()}async _getAtomicId(){return this._atomicId||(this._atomicId=await A.instance.getId()),this._atomicId}async fetch(){const e=u.config.userUid||"",t=new URLSearchParams({user_uid:e,platform:this.platform,user_atomic_id:await this._getAtomicId()}),i=await fetch(`${this._endpoint}/latest?${t.toString()}`,{headers:this._defaultHeaders});if(!i.ok)throw new Error(`Failed to fetch latest announcement: ${i.status} ${i.statusText}`);if(i.status===204)return null;const r=await i.json();return R.fromRequest(r)}async fetchAndShowDialog(e){const t=await this.fetch();return this.showDialog(t,e)}async showDialog(e,t){return e?new Promise(i=>{const r=new ee(e,t);r.onClicked=()=>{e.markAsClicked(),this.sendInteraction(e),i(e)},r.onDismissed=()=>{e.markAsDismissed(),this.sendInteraction(e),i(e)},e.start(),r.show()}):null}async sendInteraction(e){e.isRunning&&e.markAsDismissed();const t=await fetch(`${this._endpoint}/interactions`,{method:"POST",headers:this._defaultHeaders,body:JSON.stringify({announcement_id:e.id,user_uid:u.config.userUid,user_atomic_id:await this._getAtomicId(),read_time:e.readTime,clicked:e.clicked,locale:e.locale,platform:this.platform})});if(!t.ok)throw new Error(`Failed to send interaction: ${t.status} ${t.statusText}`)}_updateHeaders(){this._defaultHeaders={"Accept-Language":u.locale,"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"}}}class C extends Error{constructor(t,i,r=null){super(t);s(this,"response");s(this,"data");this.response=i,this.data=r}get serverMessage(){return this.data instanceof Object&&"message"in this.data?this.data.message:null}get status(){return this.response.status}}var g=(n=>(n.Int="int",n.Double="double",n.String="string",n.Json="json",n.None="none",n))(g||{});class x{constructor(){s(this,"code","");s(this,"message",null);s(this,"rewardType","");s(this,"value",null);s(this,"valueDataType",g.None)}static fromJson(e){const t=new x;return t.code=e.code,t.message=e.message,t.rewardType=e.reward_type,t.valueDataType=e.reward_data_type,t.value=this._parseValue(e.reward_value,t.valueDataType),t}static _parseValue(e,t){switch(t){case g.Int:return parseInt(e,10);case g.Double:return parseFloat(e);case g.String:return e;case g.Json:return JSON.parse(e);case g.None:return null;default:return null}}}class L extends C{}class se{constructor(e){s(this,"_endpoint");if(!e.gameSlug)throw new Error("The game slug is required");if(!e.endpoint)throw new Error("The endpoint is required");this._endpoint=`${e.endpoint}/games/${e.gameSlug}/coupons`}async redeem(e){const t=await u.getAtomicId(),i=await fetch(`${this._endpoint}/redeem`,{method:"POST",body:JSON.stringify({code:e,user_atomic_id:t,user_uid:u.config.userUid}),headers:{"Content-Type":"application/json","Accept-Language":u.locale}}),r=await i.json();if(i.status===400)throw new L(r.message||"Failed to redeem coupon",i,r);if(!i.ok)throw new C(`Failed to redeem coupon: ${i.status}. Server Message: ${r==null?void 0:r.message}`,i,r);return x.fromJson(r)}}class ie extends k{async initialize(){return new Promise((e,t)=>{const i=setTimeout(()=>e(),5e3);document.addEventListener("deviceready",()=>{clearTimeout(i),e()})})}getDeviceModel(){return device?device.model:null}getDeviceManufacturer(){return device?device.manufacturer:null}getOsName(){var e,t;if(!device)return null;switch((t=(e=device.platform)==null?void 0:e.toLowerCase())==null?void 0:t.replace(" ","")){case"ios":return b.IOS;case"android":return b.Android;case"windows":return b.Windows;case"macos":case"macosx":return b.MacOS}return null}getOsVersion(){return device?device.version:null}}class w{}s(w,"BrowserDataCollector",k),s(w,"CordovaDataCollector",ie),s(w,"PlaysaurusNetworkError",C),s(w,"CouponRedeemError",L),s(w,"CouponRewardDataType",g);const m=class m extends w{static get locale(){var e;return((e=this._config)==null?void 0:e.locale)??"en"}static set locale(e){var t,i;if(e!==this.locale){if(!this._config)throw new Error("The Playsaurus SDK has not been initialized. Call Playsaurus.initialize() first.");this._config.locale=e.replace("_","-"),(t=this._analytics)==null||t.notifyLocaleChanged(),(i=this._announcements)==null||i.notifyLocaleChanged()}}static initialize(e){var i;if(this._instance!==null)throw new Error("The Playsaurus SDK has already been initialized.");const t=e.endpoint||m.DEFAULT_ENDPOINT;e.endpoint=t==null?void 0:t.replace(/\/$/,""),e.locale??(e.locale=navigator.language||"en"),this._config=e,(((i=e.analytics)==null?void 0:i.enabled)??!1)&&(this._analytics=new Y(e))}static _assertInitialized(){if(!this._config)throw new Error("The Playsaurus SDK has not been initialized. Call Playsaurus.initialize() first.")}static get config(){return this._assertInitialized(),this._config}static get analytics(){if(this._assertInitialized(),!this._analytics)throw new Error("The analytics service has not been enabled. Enable it in the PlaysaurusConfig.");return this._analytics}static get announcements(){return this._assertInitialized(),this._announcements??(this._announcements=new te(this._config))}static get coupons(){return this._assertInitialized(),this._coupons??(this._coupons=new se(this._config))}static async getAtomicId(){return A.instance.getId()}};s(m,"version","5.2.2"),s(m,"DEFAULT_ENDPOINT","https://app.playsaurus.com/api"),s(m,"_instance",null),s(m,"_analytics",null),s(m,"_announcements",null),s(m,"_coupons",null),s(m,"_config",null);let u=m;return u});
